<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.thisteam.muhansangsa.mapper.StockMapper">

	<select id="selectStockList" resultType="Stock_viewVO">
		SELECT * 
		FROM stock_view
			<if test="!keyword.equals('')">
			
			<!-- 2. 검색타입(searchType) 에 따른 WHERE 대상 변경 -->
			<!-- => 조건이 복수개이므로 choose 태그 사용 -->
			<choose>
				<when test="searchType.equals('STOCK_CD')">
					WHERE STOCK_CD LIKE '%${keyword}%'
				</when>
				<when test="searchType.equals('PRODUCT_NAME')">
					WHERE PRODUCT_NAME LIKE '%${keyword}%'
				</when>
				<otherwise>
				</otherwise>
			</choose>		
			</if>
			
			LIMIT #{startRow}, #{listLimit}
	</select>

	<!-- 재고이력 목록 조회 -->
	<select id="selectHistoryList" resultType="StockHistoryViewVO">
		SELECT * 
			FROM stock_history_view
			WHERE STOCK_CD = #{stock_cd}
	</select>
	
	<!-- 이동 & 조정수량 입력을 통한 재고 수량 변경 -->
	<update id="updateStockQty" >
		UPDATE stock 
			SET STOCK_QTY = #{qty}
				WHERE STOCK_CD = #{stock_cd}
	</update>

	<!--  sId를 통한 사원번호 조회 -->
	<select id="selectEmpNum" resultType="String">
		SELECT emp_num 
			FROM employees
			WHERE emp_email = #{sId}
	</select>
	
	<insert id="insertStockHistory">
		<selectKey keyProperty="PRODUCT_CD" order="BEFORE" resultType="String">
			SELECT PRODUCT_CD 	
				FROM stock 
				WHERE STOCK_CD = #{stock.stock_cd}
		</selectKey>
		INSERT INTO stock_history
			VALUES (
				STOCK_CD = #{stock.stock_cd} 
			    ,STOCK_CONTROL_TYPE_CD = #{stock.stock_control_type_cd}
			    ,PRODUCT_CD = #{PRODUCT_CD}
			    ,SOURCE_STOCK_CD = #{stock.source_stock_cd}
			    ,TARGET_STOCK_CD = #{stock.target_stock_cd}
			    ,QTY = #{stock.qty}
				,EMP_NUM = #{stock.emp_num}
				,now()
				,REMARKS = ""
			)
	</insert>
</mapper>
